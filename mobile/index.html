<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AIMG Mobile Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'dark-bg': '#0b0c10',
                        'light-bg': '#f3f4f6',
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Outfit:wght@500;700&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body
    class="bg-gray-100 dark:bg-[#0b0c10] text-gray-900 dark:text-gray-200 font-['Inter'] antialiased transition-colors duration-300">
    <!-- Main App Container -->
    <div id="app" v-cloak
        class="min-h-screen flex flex-col md:max-w-[1800px] md:mx-auto md:border-x md:border-black/5 dark:md:border-white/5 shadow-2xl bg-gray-50 dark:bg-[#0b0c10]">
        <!-- Top Header -->
        <header
            class="sticky top-0 z-40 backdrop-blur-xl bg-white/80 dark:bg-[#0b0c10]/80 border-b border-black/5 dark:border-white/5 px-4 min-h-[64px] py-1 flex items-center justify-between safe-top">
            <!-- Brand -->
            <div class="flex items-center gap-4">
                <h1
                    class="text-xl font-['Outfit'] font-bold bg-gradient-to-r from-blue-400 to-indigo-500 bg-clip-text text-transparent">
                    AIMG PRO
                </h1>
            </div>

            <!-- Tab Switcher (Visible only on Tablet, hidden on Mobile (use bottom nav) and Desktop (split view)) -->
            <div class="hidden md:flex lg:hidden items-center bg-black/5 dark:bg-white/5 p-1 rounded-xl">
                <button @click="activeTab = 'gallery'"
                    :class="activeTab === 'gallery' ? 'bg-white dark:bg-white/10 text-blue-600 dark:text-blue-400 shadow-sm' : 'text-gray-500 hover:text-gray-700 dark:hover:text-white'"
                    class="px-5 py-1.5 rounded-lg text-sm font-bold transition-all flex items-center gap-2 whitespace-nowrap">
                    <svg class="w-4.5 h-4.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z">
                        </path>
                    </svg>
                    <span>画廊</span>
                </button>
                <button @click="activeTab = 'create'"
                    :class="activeTab === 'create' ? 'bg-white dark:bg-white/10 text-blue-600 dark:text-blue-400 shadow-sm' : 'text-gray-500 hover:text-gray-700 dark:hover:text-white'"
                    class="px-5 py-1.5 rounded-lg text-sm font-bold transition-all flex items-center gap-2 whitespace-nowrap">
                    <svg class="w-4.5 h-4.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z">
                        </path>
                    </svg>
                    <span>生图</span>
                </button>
            </div>

            <!-- Action Group: Now includes the Scale Slider correctly on the right -->
            <div class="flex items-center gap-3">
                <!-- Gallery Scale Slider (Desktop Only) - Moved here to be on the right -->
                <div v-show="activeTab === 'gallery' || isDesktop"
                    class="hidden lg:flex items-center gap-2 px-3 mr-1 border-r border-black/5 dark:border-white/5">
                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4">
                        </path>
                    </svg>
                    <input v-model.number="galleryScale" type="range" min="80" max="400" step="10"
                        class="w-24 h-1.5 bg-black/10 dark:bg-white/20 rounded-lg appearance-none cursor-pointer accent-blue-500">
                </div>

                <div class="flex items-center gap-1.5 px-2">
                    <button @click="showFilters = true"
                        class="w-10 h-10 flex items-center justify-center rounded-full bg-white dark:bg-white/10 border border-black/10 dark:border-white/20 shadow-sm hover:bg-gray-50 dark:hover:bg-white/20 active:scale-90 transition-all text-gray-900 dark:text-white"
                        title="搜索与筛选">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </button>
                    <button @click="toggleTheme"
                        class="w-10 h-10 flex items-center justify-center rounded-full bg-white dark:bg-white/10 border border-black/10 dark:border-white/20 shadow-sm hover:bg-gray-50 dark:hover:bg-white/20 active:rotate-90 transition-all duration-500 text-gray-900 dark:text-white"
                        title="切换主题">
                        <template v-if="isDark">
                            <svg class="w-5 h-5 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364-6.364l-.707.707M6.343 17.657l-.707.707m12.728 0l-.707-.707M6.343 6.343l-.707-.707M12 5a7 7 0 100 14 7 7 0 000-14z">
                                </path>
                            </svg>
                        </template>
                        <template v-else>
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z">
                                </path>
                            </svg>
                        </template>
                    </button>
                </div>
            </div>
        </header>

        <!-- Navigation Tabs (Mobile Only) -->
        <nav class="md:hidden flex border-b border-black/5 dark:border-white/5 bg-white dark:bg-[#0b0c10]">
            <button @click="activeTab = 'gallery'" :class="{'tab-active': activeTab === 'gallery'}"
                class="flex-1 py-3 text-sm font-medium relative transition-colors">画廊</button>
            <button @click="activeTab = 'create'" :class="{'tab-active': activeTab === 'create'}"
                class="flex-1 py-3 text-sm font-medium relative transition-colors">生图</button>
        </nav>

        <!-- Main Content -->
        <!-- Main Content -->
        <main class="flex-1 flex lg:flex-row flex-col overflow-hidden relative resize-container">
            <!-- Gallery View -->
            <div v-show="activeTab === 'gallery' || isDesktop"
                class="flex-1 overflow-y-auto scroll-area gallery-scroll-area resize-panel" @scroll="onGalleryScroll">
                <!-- Mini Search Bar -->
                <div class="sticky top-0 z-10 bg-gray-100/80 dark:bg-[#0b0c10]/80 backdrop-blur-md px-3 py-2">
                    <input v-model="searchKeyword" @keyup.enter="refreshImages" type="text" placeholder="搜索关键词..."
                        class="w-full bg-white dark:bg-white/5 border border-gray-200 dark:border-white/10 rounded-xl px-4 py-2 text-sm text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:border-blue-500/50 dark:focus:border-blue-500/50">
                </div>
                <!-- Photo Grid -->
                <div class="image-grid-container"
                    :style="{ gridTemplateColumns: `repeat(auto-fill, minmax(${galleryScale}px, 1fr))` }">
                    <div v-for="img in images" :key="img.file_path" @click="viewDetail(img)"
                        class="image-grid-item relative overflow-hidden" :style="{ 
                             backgroundColor: img.placeholderColor + '40', // 40 = 25% opacity
                             aspectRatio: img.aspectRatio || 0.66,
                             contentVisibility: 'auto'
                         }">
                        <!-- 
                           Phase 1 Optimization:
                           1. Use /thumb endpoint for list (768px is plenty for grid).
                           2. restoration of raw for detail view (kept in detail section).
                           3. decoding="async" for non-blocking UI.
                        -->
                        <img :src="'/api/image/thumb?path=' + encodeURIComponent(img.file_path) + '&size=768'"
                            :width="img.width" :height="img.height" loading="lazy" decoding="async"
                            class="w-full h-full object-cover transition-opacity duration-500 opacity-0"
                            onload="this.classList.remove('opacity-0')"
                            @error="e => e.target.closest('.image-grid-item').style.display = 'none'">
                    </div>
                </div>
                <!-- Infinite Scroll Loader -->
                <div v-if="loading" class="flex justify-center p-8">
                    <div class="animate-spin rounded-full h-6 w-6 border-t-2 border-blue-500"></div>
                </div>
            </div>

            <!-- Resize Handle (Desktop Only) -->
            <div v-if="isDesktop"
                class="hidden lg:flex w-1 cursor-col-resize items-center justify-center hover:bg-blue-500/20 transition-colors resize-handle"
                @mousedown="startResize" @touchstart="startResize">
                <div class="w-0.5 h-8 bg-white/20 rounded-full"></div>
            </div>

            <!-- Create View (Generation Workspace) -->
            <div v-show="activeTab === 'create' || isDesktop"
                class="flex-1 lg:flex-none overflow-y-auto scroll-area create-scroll-area bg-white dark:bg-[#0b0c10] lg:bg-white/50 lg:dark:bg-[#161920]/50 lg:border-l lg:border-black/5 lg:dark:border-white/5 shadow-xl lg:shadow-none z-10 resize-panel"
                :style="{ width: isDesktop ? settingsWidth + 'px' : '100%' }">

                <!-- Header -->
                <div class="px-4 pt-4 pb-3 border-b border-white/5">
                    <h2 class="text-lg font-bold text-gray-900 dark:text-white">生成设置</h2>
                </div>

                <!-- Main Form Content -->
                <div class="p-4 space-y-6">
                    <!-- Model & LoRA Section -->
                    <div class="space-y-4">
                        <div class="flex items-center gap-2">
                            <svg class="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10">
                                </path>
                            </svg>
                            <label class="text-xs font-bold text-gray-500 uppercase tracking-wider">模型与 LoRA</label>
                        </div>
                        <div class="grid grid-cols-1 gap-3">
                            <select v-model="genParams.model"
                                class="w-full glass-input px-4 py-3 text-sm appearance-none outline-none text-gray-900 dark:text-gray-200 bg-black/5 dark:bg-white/5 border-black/5 dark:border-white/10 focus:border-blue-500 rounded-xl">
                                <option v-for="m in filterData.models" :key="m" :value="m">{{ m }}</option>
                            </select>
                            <div class="flex gap-2">
                                <select v-model="genParams.lora"
                                    class="flex-1 glass-input px-4 py-3 text-sm appearance-none outline-none text-gray-900 dark:text-gray-200 bg-black/5 dark:bg-white/5 border-black/5 dark:border-white/10 rounded-xl">
                                    <option value="">不使用 LoRA</option>
                                    <option v-for="l in filterData.loras" :key="l" :value="l">{{ l }}</option>
                                </select>
                                <input v-if="genParams.lora" v-model.number="genParams.lora_weight" type="number"
                                    min="0.1" max="2.0" step="0.01"
                                    class="w-20 glass-input px-3 py-3 text-sm outline-none text-gray-900 dark:text-gray-200 bg-black/5 dark:bg-white/5 border-black/5 dark:border-white/10 rounded-xl text-center"
                                    placeholder="权重">
                            </div>
                        </div>
                    </div>

                    <!-- Basic Parameters Section -->
                    <div class="space-y-4">
                        <div class="flex items-center gap-2">
                            <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
                                </path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            <label class="text-xs font-bold text-gray-500 uppercase tracking-wider">基本参数</label>
                        </div>
                        <div class="grid grid-cols-2 lg:grid-cols-3 gap-3">
                            <div class="space-y-1">
                                <label class="text-xs text-gray-500">分辨率</label>
                                <select v-model="genParams.resolution"
                                    class="w-full glass-input px-3 py-2.5 text-sm outline-none text-gray-900 dark:text-gray-200 bg-black/5 dark:bg-white/5 border-black/5 dark:border-white/10 rounded-lg">
                                    <option v-for="res in filterData.resolutions" :key="res" :value="res">{{ res }}
                                    </option>
                                    <option v-if="!filterData.resolutions.includes('512x768')" value="512x768">512×768
                                    </option>
                                    <option v-if="!filterData.resolutions.includes('768x512')" value="768x512">768×512
                                    </option>
                                </select>
                            </div>
                            <div class="space-y-1">
                                <label class="text-xs text-gray-500">步数</label>
                                <input v-model.number="genParams.steps" type="number"
                                    class="w-full glass-input px-3 py-2.5 text-sm outline-none text-gray-900 dark:text-gray-200 bg-black/5 dark:bg-white/5 border-black/5 dark:border-white/10 rounded-lg">
                            </div>
                            <div class="space-y-1">
                                <label class="text-xs text-gray-500">采样器</label>
                                <select v-model="genParams.sampler"
                                    class="w-full glass-input px-3 py-2.5 text-sm outline-none text-gray-900 dark:text-gray-200 bg-black/5 dark:bg-white/5 border-black/5 dark:border-white/10 rounded-lg">
                                    <option v-for="s in filterData.samplers" :key="s" :value="s">{{ s }}</option>
                                </select>
                            </div>
                            <div class="space-y-1">
                                <label class="text-xs text-gray-500">调度器</label>
                                <select v-model="genParams.scheduler"
                                    class="w-full glass-input px-3 py-2.5 text-sm outline-none text-gray-900 dark:text-gray-200 bg-black/5 dark:bg-white/5 border-black/5 dark:border-white/10 rounded-lg">
                                    <option v-for="sc in filterData.schedulers" :key="sc" :value="sc">{{ sc }}</option>
                                </select>
                            </div>
                            <div class="space-y-1">
                                <label class="text-xs text-gray-500">CFG</label>
                                <input v-model.number="genParams.cfg" type="number" min="1" max="20" step="0.5"
                                    class="w-full glass-input px-3 py-2.5 text-sm outline-none text-gray-900 dark:text-gray-200 bg-black/5 dark:bg-white/5 border-black/5 dark:border-white/10 rounded-lg">
                            </div>
                        </div>
                    </div>

                    <!-- Positive Prompt Section -->
                    <div class="space-y-2">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                    </path>
                                </svg>
                                <label class="text-xs font-bold text-blue-400 uppercase tracking-wider">正向提示词</label>
                            </div>
                            <div class="flex items-center gap-1">
                                <button @click="handleFileImport" title="文件导入"
                                    class="p-1.5 rounded-lg bg-white/5 border border-white/10 text-blue-400 active:scale-90 transition-all hover:bg-white/10">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                                    </svg>
                                </button>
                                <button @click="handleClipboardImport" title="剪贴板导入"
                                    class="p-1.5 rounded-lg bg-white/5 border border-white/10 text-blue-400 active:scale-90 transition-all hover:bg-white/10">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2">
                                        </path>
                                    </svg>
                                </button>
                                <button @click="openAIModal" title="AI 优化"
                                    class="p-1.5 rounded-lg bg-gradient-to-br from-purple-500/10 to-blue-500/10 border border-blue-500/20 text-blue-400 active:scale-90 transition-all hover:from-purple-500/20 hover:to-blue-500/20">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <textarea v-model="genParams.prompt" rows="4"
                            class="w-full glass-input px-4 py-3 text-sm outline-none resize-none focus:ring-1 focus:ring-blue-500/50 text-gray-900 dark:text-gray-200 bg-black/5 dark:bg-white/5 border-black/5 dark:border-white/10 rounded-xl"
                            placeholder="描述你想生成的画面..."></textarea>
                        <input type="file" ref="fileInput" @change="onFileChanged" accept="image/*" class="hidden">
                    </div>

                    <!-- Negative Prompt Section -->
                    <div class="space-y-2">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <svg class="w-4 h-4 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636">
                                    </path>
                                </svg>
                                <label class="text-xs font-bold text-red-400 uppercase tracking-wider">负向提示词</label>
                            </div>
                            <button @click="openAIModal('negative')" title="AI 优化"
                                class="p-1.5 rounded-lg bg-gradient-to-br from-purple-500/10 to-blue-500/10 border border-blue-500/20 text-blue-400 active:scale-90 transition-all hover:from-purple-500/20 hover:to-blue-500/20">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                </svg>
                            </button>
                        </div>
                        <textarea v-model="genParams.negative_prompt" rows="2"
                            class="w-full glass-input px-4 py-3 text-sm outline-none resize-none opacity-60 focus:opacity-100 transition-opacity text-gray-900 dark:text-gray-200 bg-black/5 dark:bg-white/5 border-black/5 dark:border-white/10 rounded-xl"
                            placeholder="不想出现的内容..."></textarea>
                    </div>
                    <div class="h-20 md:hidden"></div> <!-- Spacer for mobile fixed button -->
                </div>

                <!-- Generate Button (Fixed at Bottom) -->
                <div
                    class="sticky bottom-0 p-4 bg-white/90 dark:bg-[#0b0c10]/90 backdrop-blur-md border-t border-white/10 safe-bottom">
                    <button @click="submitGeneration" :disabled="isGenerating"
                        class="w-full py-4 rounded-xl bg-blue-600 hover:bg-blue-500 text-white font-bold shadow-lg shadow-blue-600/20 active:scale-[0.98] transition-all flex items-center justify-center gap-2">
                        <span v-if="isGenerating"
                            class="animate-spin rounded-full h-5 w-5 border-2 border-white/30 border-t-white"></span>
                        <svg v-else class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                        {{ isGenerating ? '正在生成...' : '开始生图' }}
                    </button>
                </div>

                <!-- Task Queue Section -->
                <div class="p-4 space-y-4 border-t border-white/5">
                    <div class="flex items-center gap-2">
                        <svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4">
                            </path>
                        </svg>
                        <label class="text-xs font-bold text-gray-500 uppercase tracking-wider">任务队列</label>
                    </div>

                    <div v-if="queueData.pending.length === 0"
                        class="p-6 text-center text-gray-500 text-sm bg-white/5 rounded-xl">
                        暂无活跃任务
                    </div>

                    <div v-else class="space-y-2">
                        <!-- Pending Tasks Only -->
                        <div v-for="task in queueData.pending" :key="task.id"
                            class="p-3 rounded-xl bg-blue-500/5 border border-blue-500/10 flex flex-col gap-2">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <span class="flex h-2 w-2 rounded-full"
                                        :class="task.status === 'running' ? 'bg-green-400 animate-pulse' : 'bg-blue-400'"></span>
                                    <span class="text-sm font-medium text-gray-700 dark:text-gray-300">{{
                                        task.description }}</span>
                                </div>
                                <span class="text-[10px] text-blue-400 font-bold uppercase">{{ task.status === 'running'
                                    ? 'Running' : 'Waiting' }}</span>
                            </div>
                            <div v-if="task.status === 'running' && queueData.progress > 0" class="w-full">
                                <div class="w-full bg-white/10 rounded-full h-1.5 overflow-hidden">
                                    <div class="bg-blue-500 h-full transition-all duration-300"
                                        :style="{ width: queueData.progress + '%' }"></div>
                                </div>
                                <div class="flex justify-between text-[10px] text-gray-500 mt-1">
                                    <span>{{ queueData.progress }}%</span>
                                    <span>剩余: {{ comfyStatus.queue_remaining }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Filter Drawer -->
        <div v-if="showFilters" class="fixed inset-0 z-50 flex flex-col justify-end md:justify-center md:items-center">
            <div @click="showFilters = false" class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
            <div
                class="relative bg-white dark:bg-[#161920] rounded-t-3xl md:rounded-3xl drawer active flex flex-col max-h-[85vh] w-full md:w-[600px] md:shadow-2xl border border-black/5 dark:border-white/5 text-gray-900 dark:text-gray-200">
                <div class="px-6 pt-6">
                    <div class="w-12 h-1.5 bg-black/10 dark:bg-white/10 rounded-full mx-auto mb-6"></div>
                    <h2 class="text-lg font-bold mb-6">高级筛选</h2>
                </div>

                <div class="flex-1 overflow-y-auto px-6 space-y-6 scroll-area">
                    <section v-for="(options, key) in filterData" :key="key" class="space-y-3">
                        <label class="form-label">{{ key === 'folders' ? '文件夹' : (key ===
                            'models' ? '模型' : 'LoRA') }}</label>
                        <div class="flex flex-wrap gap-2">
                            <button v-for="opt in options" :key="opt" @click="toggleFilter(key, opt)"
                                :class="isFilterSelected(key, opt) ? 'bg-blue-500 text-white border-blue-400' : 'bg-black/5 dark:bg-white/5 text-gray-600 dark:text-gray-400 border-black/5 dark:border-white/5 hover:bg-black/10 dark:hover:bg-white/10'"
                                class="px-3 py-1.5 text-xs rounded-full border transition-all">
                                {{ key === 'folders' ? fileName(opt) : opt }}
                            </button>
                        </div>
                    </section>
                </div>

                <div
                    class="p-6 border-t border-black/5 dark:border-white/5 flex gap-3 bg-white dark:bg-[#161920] rounded-b-3xl">
                    <button @click="resetFilters"
                        class="flex-1 py-3 rounded-xl bg-black/5 dark:bg-white/5 font-medium hover:bg-black/10 dark:hover:bg-white/10 transition-colors">重置</button>
                    <button @click="applyFilters"
                        class="flex-1 py-3 rounded-xl bg-blue-600 text-white font-bold shadow-lg shadow-blue-600/20 active:scale-95 transition-all">查看结果</button>
                </div>
            </div>
        </div>

        <!-- AI Optimize Modal -->
        <div v-if="showAIModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 md:p-6">
            <div @click="showAIModal = false" class="absolute inset-0 bg-black/80 backdrop-blur-md"></div>
            <div
                class="relative w-full max-w-lg bg-white dark:bg-[#161920] rounded-2xl p-5 border border-black/5 dark:border-white/10 text-gray-900 dark:text-gray-200">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold">AI 提示词优化</h3>
                    <button @click="showAIModal = false" class="p-1.5 rounded-lg hover:bg-white/10">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12">
                            </path>
                        </svg>
                    </button>
                </div>

                <p class="text-xs text-gray-500 mb-4">
                    输入你的需求或修改指令，AI 将生成/优化提示词。
                </p>

                <!-- AI Input -->
                <div class="space-y-3">
                    <textarea v-model="aiInput" @keydown.enter.prevent="runAIOptimize" rows="3"
                        class="w-full glass-input px-4 py-3 text-sm outline-none text-gray-900 dark:text-gray-200 bg-black/5 dark:bg-white/5"
                        :placeholder="aiTarget === 'negative' ? '例如：不要模糊，不要多余的手指' : '例如：一个赛博朋克风格的都市夜景，换成JK制服'"></textarea>

                    <button @click="runAIOptimize" :disabled="aiLoading || !aiInput.trim()"
                        class="w-full py-3 rounded-xl bg-gradient-to-r from-purple-600 to-blue-600 text-white font-bold flex items-center justify-center gap-2 disabled:opacity-50">
                        <span v-if="aiLoading"
                            class="animate-spin rounded-full h-4 w-4 border-2 border-white/30 border-t-white"></span>
                        {{ aiLoading ? 'AI 处理中...' : '开始处理' }}
                    </button>
                </div>

                <!-- Result Preview (Streaming) -->
                <div v-if="aiResult" class="mt-4 p-3 bg-white/5 rounded-lg">
                    <div class="flex items-center justify-between mb-2">
                        <label class="text-xs text-gray-400">生成结果</label>
                        <button @click="copyAIResult" class="text-xs text-blue-400 hover:text-blue-300">复制</button>
                    </div>
                    <p class="text-sm text-gray-300 leading-relaxed whitespace-pre-wrap">{{ aiResult }}</p>
                </div>
            </div>
        </div>

        <!-- Detail Viewer -->
        <transition name="fade">
            <div v-if="selectedImage" @wheel="handleWheel"
                class="fixed inset-0 z-50 flex flex-col items-center justify-start md:justify-center overflow-y-auto p-0 md:p-8 lg:p-12 glass-modal-wrapper">
                <!-- Backdrop -->
                <div class="fixed inset-0 bg-black/95 backdrop-blur-3xl transition-all duration-500"
                    @click="closeDetail"></div>

                <!-- Modal Content: Modern Card (Scrollable whole card on mobile) -->
                <div class="relative w-full min-h-full md:min-h-0 md:w-auto md:max-w-[95vw] md:max-h-[92vh] bg-white dark:bg-[#0b0c10] md:rounded-[32px] shadow-[0_50px_100px_rgba(0,0,0,0.5)] overflow-hidden flex flex-col md:flex-row text-gray-900 dark:text-gray-200"
                    @touchstart="handleTouchStart" @touchend="handleTouchEnd">

                    <!-- Photo Display Section (LEFT) -->
                    <div
                        class="relative flex-1 md:flex-none min-h-[50vh] md:min-h-0 bg-gray-50 dark:bg-black flex items-center justify-center overflow-hidden z-10 order-1">
                        <!-- Premium Blurred Background -->
                        <div class="absolute inset-0 opacity-40 blur-3xl scale-125 saturate-150 pointer-events-none"
                            :style="{ backgroundImage: 'url(/api/image/raw?path=' + encodeURIComponent(selectedImage.file_path) + ')', backgroundSize: 'cover', backgroundPosition: 'center' }">
                        </div>

                        <!-- Main Image -->
                        <img :src="'/api/image/raw?path=' + encodeURIComponent(selectedImage.file_path)"
                            :class="imageAnimationClass"
                            class="max-w-full max-h-[75vh] md:max-h-[88vh] w-auto h-auto object-contain relative z-10 transition-transform duration-300 drop-shadow-2xl">

                        <!-- Navigation Buttons: Vertically Centered on Image Area -->
                        <button @click.stop="navigateImage(-1)"
                            class="absolute left-6 top-1/2 -translate-y-1/2 z-20 p-4 rounded-full bg-black/20 text-white/50 hover:bg-black/40 hover:text-white backdrop-blur-xl border border-white/10 transition-all hidden md:block">
                            <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                    d="M15 19l-7-7 7-7">
                                </path>
                            </svg>
                        </button>
                        <button @click.stop="navigateImage(1)"
                            class="absolute right-6 top-1/2 -translate-y-1/2 z-20 p-4 rounded-full bg-black/20 text-white/50 hover:bg-black/40 hover:text-white backdrop-blur-xl border border-white/10 transition-all hidden md:block">
                            <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                    d="M9 5l7 7-7 7">
                                </path>
                            </svg>
                        </button>
                    </div>

                    <!-- Metadata Section (RIGHT) -->
                    <div id="detail-info" @wheel.stop
                        class="w-full md:w-[400px] md:flex-shrink-0 md:border-l border-black/5 dark:border-white/5 flex flex-col bg-white/95 dark:bg-[#0b0c10]/95 backdrop-blur-md order-2 relative">

                        <!-- Metadata Content: Scrollable -->
                        <div class="flex-1 p-6 space-y-8 overflow-y-auto scroll-area">
                            <div v-if="!meta"
                                class="py-20 flex flex-col items-center justify-center text-gray-400 gap-4">
                                <div
                                    class="animate-spin rounded-full h-8 w-8 border-2 border-blue-500/20 border-t-blue-500">
                                </div>
                                <span
                                    class="text-xs font-bold uppercase tracking-widest text-blue-500/50">读取数据...</span>
                            </div>
                            <div v-else class="space-y-6">
                                <div v-if="meta.prompt" class="space-y-3">
                                    <label
                                        class="text-[10px] font-black text-blue-600 dark:text-blue-400 uppercase tracking-[0.3em] block">正向提示词</label>
                                    <div
                                        class="text-[13px] leading-relaxed text-gray-700 dark:text-gray-300 bg-gray-50 dark:bg-white/5 p-4 rounded-2xl border border-black/5 dark:border-white/5 break-words select-all">
                                        {{ meta.prompt }}</div>
                                </div>
                                <div v-if="meta.negative_prompt" class="space-y-3">
                                    <label
                                        class="text-[10px] font-black text-red-600 dark:text-red-400 uppercase tracking-[0.3em] block">负向提示词</label>
                                    <div
                                        class="text-[13px] leading-relaxed text-gray-500 dark:text-gray-400 bg-gray-50 dark:bg-white/5 p-4 rounded-2xl border border-black/5 dark:border-white/5 break-words select-all italic">
                                        {{ meta.negative_prompt }}</div>
                                </div>
                                <!-- Full Parameter Matrix -->
                                <div class="space-y-4 pt-4 border-t border-black/10 dark:border-white/10">
                                    <label
                                        class="text-[10px] font-black text-gray-400 uppercase tracking-[0.3em] block">生成参数详情</label>
                                    <div class="grid grid-cols-2 gap-2 text-[11px]">
                                        <div v-for="(v, k) in { 
                                            '模型': getParam('model'), 
                                            '尺寸': getImageDimensions(), 
                                            '采样': getParam('sampler_name'), 
                                            '步数': getParam('steps'),
                                            'CFG': getParam('cfg'),
                                            '种子': getParam('seed')
                                        }"
                                            class="bg-gray-50 dark:bg-white/5 p-3 rounded-xl border border-black/5 dark:border-white/5">
                                            <div class="text-[9px] text-gray-400 mb-1 font-bold">{{ k }}</div>
                                            <div class="truncate font-mono text-gray-900 dark:text-gray-300">{{ v || '-'
                                                }}</div>
                                        </div>
                                    </div>
                                    <!-- LoRA Display -->
                                    <div v-if="meta.loras && meta.loras.length > 0"
                                        class="bg-gray-50 dark:bg-white/5 p-4 rounded-xl border border-black/5 dark:border-white/5">
                                        <div class="text-[9px] text-gray-400 mb-2 font-bold lowercase">lora 列表</div>
                                        <div class="flex flex-wrap gap-1.5">
                                            <span v-for="l in meta.loras" :key="l"
                                                class="px-2 py-1 bg-purple-500/10 border border-purple-500/10 rounded text-[9px] text-purple-600 dark:text-purple-400">{{
                                                l }}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="h-36"></div> <!-- Space for sticky buttons -->
                            </div>
                        </div>

                        <!-- Sticky Buttons: Modern Adaptive Design -->
                        <div
                            class="absolute bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-white via-white/95 dark:from-black dark:via-black/95 to-transparent border-t border-black/5 dark:border-white/5 flex flex-col gap-3 z-30 backdrop-blur-sm">
                            <button @click="applyToWorkspace"
                                class="w-full py-4 bg-blue-600/10 hover:bg-blue-600 text-blue-600 dark:text-blue-400 hover:text-white border border-blue-600/20 rounded-2xl font-bold flex items-center justify-center gap-3 active:scale-95 transition-all">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z">
                                    </path>
                                </svg>
                                <span>存为提示词</span>
                            </button>
                            <button @click="confirmDelete"
                                class="w-full py-4 bg-red-600/5 hover:bg-red-600 text-red-600 dark:text-red-500 hover:text-white border border-red-600/20 rounded-2xl font-bold flex items-center justify-center gap-3 active:scale-95 transition-all">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                    </path>
                                </svg>
                                <span>删除此图片</span>
                            </button>
                        </div>
                    </div>

                    <!-- Absolute Close Button: TOP RIGHT of card -->
                    <div class="absolute top-12 right-5 md:top-6 md:right-6 z-[100]">
                        <button @click="closeDetail"
                            class="p-3 rounded-full bg-black/5 dark:bg-white/10 text-gray-900 dark:text-white backdrop-blur-3xl border border-black/10 dark:border-white/20 shadow-xl hover:bg-black/10 dark:hover:bg-white/20 active:scale-90 transition-all"
                            title="关闭详情">
                            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                    d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </transition>
    </div>
    <script src="app.js"></script>
</body>

</html>